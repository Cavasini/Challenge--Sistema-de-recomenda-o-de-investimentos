# .github/workflows/ci-cd-main.yml
name: CI/CD - Main Branch (Production)

on:
    push:
        branches: ["main"] # Aciona apenas quando houver push para a main
    # pull_request:
    #   branches: ["main"] # Normalmente PRs para main são do tipo 'squash and merge' de develop ou feature branches

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        environment: production # Opcional: Define um ambiente no GitHub para gerenciar segredos e revisores
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            # Configuração de Java, Maven e Docker build (similar ao develop)
            - name: Setup Java
              uses: actions/setup-java@v3
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Build InvestmentDataService JAR
              working-directory: ./InvestmentDataService
              run: mvn clean install

            - name: Build ProfileAnalyzerService JAR
              working-directory: ./ProfileAnalyzerService
              run: mvn clean install

            - name: Build RecommenderService JAR
              working-directory: ./RecommenderService
              run: mvn clean install

            - name: Log in to Docker Hub
              run: docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}

            - name: Build and Push InvestmentDataService Production Image
              working-directory: ./InvestmentDataService
              run: |
                  docker build -t cavasini/investmentdataservice .
                  docker push cavasini/investmentdataservice

            # - name: Deploy to Production Environment
            #   run: |
            #       # **Comandos de deploy para produção**
            #       # Isso pode envolver:
            #       # - Atualizar um Kubernetes deployment (kubectl apply -f your-deployment.yaml)
            #       # - Usar Terraform para provisionar/atualizar infra
            #       # - Executar um script de deploy via SSH para VMs
            #       # - Chamar uma API de deployment (e.g., AWS ECS, Azure App Service)
            #       echo "Deploying to production environment using image tag: ${{ github.sha }}"
            #       # Exemplo: kubectl set image deployment/investment-data-service investment-data-service=your_docker_hub_username/investmentdataservice:${{ github.sha }}
            #   env:
            #       KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_PROD }} # Exemplo de segredo para credenciais de deploy
